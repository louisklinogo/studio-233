// Domain models for Studio+233

enum AssetType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  MODEL
  OTHER
}

enum GenerationType {
  IMAGE
  VIDEO
  BACKGROUND_REMOVAL
  OBJECT_ISOLATION
  OTHER
}

enum GenerationStatus {
  QUEUED
  RUNNING
  COMPLETED
  FAILED
}

enum BatchStatus {
  QUEUED
  PROCESSING
  VERIFYING
  COMPLETED
  FAILED
  CANCELED
}

enum WorkflowState {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELED
}

enum AgentMessageRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}

enum AgentMessageType {
  TEXT
  TOOL_RESULT
  EVENT
}

enum ToolCallStatus {
  REQUESTED
  SUCCEEDED
  FAILED
}

enum UsageMetricType {
  TOKENS
  IMAGES
  VIDEOS
  JOBS
  STORAGE_SECONDS
}

enum UsageSource {
  CANVAS
  BATCH
  CHAT
  API
  WORKFLOW
}

enum ProjectType {
  CANVAS
  STUDIO
}

model Workspace {
  id          String   @id @default(cuid())
  name        String
  description String?
  slug        String?
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  projects Project[]

  @@unique([userId, slug])
  @@index([userId])
  @@index([updatedAt(sort: Desc)]) // For workspace listing
  @@map("workspace")
}

model Project {
  id          String      @id @default(cuid())
  name        String
  description String?
  thumbnail   String?
  type        ProjectType @default(CANVAS)
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspaceId String?
  workspace   Workspace?  @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  canvases            Canvas[]
  assets              Asset[]
  generationRuns      GenerationRun[]
  batchJobs           BatchJob[]
  workflowDefinitions WorkflowDefinition[]
  workflowRuns        WorkflowRun[]
  threads             AgentThread[]
  usageSamples        UsageSample[]
  auditLogs           AuditLog[]

  @@index([userId])
  @@index([workspaceId, type])
  @@index([workspaceId, updatedAt(sort: Desc)]) // For dashboard project list
  @@map("project")
}

model Canvas {
  id             String           @id @default(cuid())
  name           String
  width          Int              @default(1920)
  height         Int              @default(1080)
  data           Json             @db.Json
  projectId      String
  project        Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  snapshots      CanvasSnapshot[]
  elements       CanvasElement[]
  generationRuns GenerationRun[]

  @@index([projectId])
  @@map("canvas")
}

model CanvasSnapshot {
  id          String          @id @default(cuid())
  canvasId    String
  canvas      Canvas          @relation(fields: [canvasId], references: [id], onDelete: Cascade)
  data        Json            @db.Json
  version     Int
  createdAt   DateTime        @default(now())
  createdById String?
  createdBy   User?           @relation(fields: [createdById], references: [id], onDelete: SetNull)
  elements    CanvasElement[]

  @@index([canvasId, version])
  @@map("canvas_snapshot")
}

model CanvasElement {
  id         String          @id @default(cuid())
  canvasId   String
  canvas     Canvas          @relation(fields: [canvasId], references: [id], onDelete: Cascade)
  snapshotId String?
  snapshot   CanvasSnapshot? @relation(fields: [snapshotId], references: [id], onDelete: SetNull)
  kind       String
  data       Json            @db.Json
  zIndex     Int             @default(0)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  @@index([canvasId])
  @@index([snapshotId])
  @@map("canvas_element")
}

model Asset {
  id         String          @id @default(cuid())
  name       String
  type       AssetType       @default(IMAGE)
  url        String
  size       Int
  mimeType   String
  metadata   Json?           @db.Json
  projectId  String
  project    Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  versions   AssetVersion[]
  inputRuns  GenerationRun[] @relation("GenerationInputAsset")
  outputRuns GenerationRun[] @relation("GenerationOutputAsset")

  @@index([projectId, type])
  @@index([projectId, createdAt(sort: Desc)]) // For asset gallery
  @@map("asset")
}

model AssetVersion {
  id           String         @id @default(cuid())
  assetId      String
  asset        Asset          @relation(fields: [assetId], references: [id], onDelete: Cascade)
  generationId String?
  generation   GenerationRun? @relation(fields: [generationId], references: [id], onDelete: SetNull)
  url          String
  checksum     String?
  mimeType     String?
  size         Int?
  metadata     Json?          @db.Json
  isPrimary    Boolean        @default(false)
  createdAt    DateTime       @default(now())

  @@index([assetId, createdAt])
  @@index([generationId])
  @@map("asset_version")
}

model GenerationRun {
  id            String           @id @default(cuid())
  userId        String?
  user          User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  projectId     String?
  project       Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)
  canvasId      String?
  canvas        Canvas?          @relation(fields: [canvasId], references: [id], onDelete: SetNull)
  type          GenerationType   @default(IMAGE)
  status        GenerationStatus @default(QUEUED)
  prompt        String?
  modelId       String?
  loraUrl       String?
  settings      Json?            @db.Json
  inputAssetId  String?
  inputAsset    Asset?           @relation("GenerationInputAsset", fields: [inputAssetId], references: [id], onDelete: SetNull)
  outputAssetId String?
  outputAsset   Asset?           @relation("GenerationOutputAsset", fields: [outputAssetId], references: [id], onDelete: SetNull)
  startedAt     DateTime?
  completedAt   DateTime?
  error         Json?            @db.Json
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  versions      AssetVersion[]

  @@index([projectId])
  @@index([userId])
  @@index([status])
  @@map("generation_run")
}

model BatchJob {
  id            String          @id @default(cuid())
  userId        String?
  user          User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  projectId     String?
  project       Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)
  label         String?
  status        BatchStatus     @default(QUEUED)
  config        Json            @db.Json
  resultSummary Json?           @db.Json
  error         Json?           @db.Json
  concurrency   Int             @default(1)
  attempts      Int             @default(0)
  startedAt     DateTime?
  completedAt   DateTime?
  canceledAt    DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  items         BatchJobItem[]
  events        BatchJobEvent[]

  @@index([userId, status])
  @@index([projectId])
  @@map("batch_job")
}

model BatchJobItem {
  id        String      @id @default(cuid())
  jobId     String
  job       BatchJob    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  inputUrl  String
  outputUrl String?
  status    BatchStatus @default(QUEUED)
  attempts  Int         @default(0)
  metadata  Json?       @db.Json
  error     Json?       @db.Json
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([jobId, status])
  @@map("batch_job_item")
}

model BatchJobEvent {
  id        String   @id @default(cuid())
  jobId     String
  job       BatchJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  type      String
  payload   Json?    @db.Json
  createdAt DateTime @default(now())

  @@index([jobId, createdAt])
  @@map("batch_job_event")
}

model WorkflowDefinition {
  id          String    @id @default(cuid())
  name        String
  description String?
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  nodes       Json      @db.Json
  edges       Json      @db.Json
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  runs        WorkflowRun[]

  @@index([userId, projectId])
  @@index([projectId])
  @@map("workflow_definition")
}

model WorkflowRun {
  id                   String               @id @default(cuid())
  workflowDefinitionId String?
  workflowDefinition   WorkflowDefinition?  @relation(fields: [workflowDefinitionId], references: [id], onDelete: SetNull)
  workflow             String               // Legacy field for backward compatibility
  state                WorkflowState        @default(PENDING)
  userId               String?
  user                 User?                @relation(fields: [userId], references: [id], onDelete: SetNull)
  projectId            String?
  project              Project?             @relation(fields: [projectId], references: [id], onDelete: SetNull)
  input                Json?                @db.Json
  output               Json?                @db.Json
  error                Json?                @db.Json
  startedAt            DateTime?
  finishedAt           DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  steps                WorkflowStep[]

  @@index([workflow, state])
  @@index([workflowDefinitionId])
  @@index([userId])
  @@map("workflow_run")
}

model WorkflowStep {
  id         String        @id @default(cuid())
  runId      String
  run        WorkflowRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  name       String
  state      WorkflowState @default(PENDING)
  order      Int           @default(0)
  toolName   String?
  input      Json?         @db.Json
  output     Json?         @db.Json
  error      Json?         @db.Json
  startedAt  DateTime?
  finishedAt DateTime?

  @@index([runId, order])
  @@map("workflow_step")
}

model AgentThread {
  id        String          @id @default(cuid())
  userId    String?
  user      User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  projectId String?
  project   Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)
  title     String?
  metadata  Json?           @db.Json
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  messages  AgentMessage[]
  toolCalls AgentToolCall[]

  @@index([userId])
  @@index([projectId])
  @@map("agent_thread")
}

model AgentMessage {
  id           String           @id @default(cuid())
  threadId     String
  thread       AgentThread      @relation(fields: [threadId], references: [id], onDelete: Cascade)
  role         AgentMessageRole
  type         AgentMessageType @default(TEXT)
  content      Json             @db.Json
  inputTokens  Int?
  outputTokens Int?
  toolCallId   String?
  toolCall     AgentToolCall?   @relation(fields: [toolCallId], references: [id], onDelete: SetNull)
  createdAt    DateTime         @default(now())

  @@index([threadId, createdAt])
  @@map("agent_message")
}

model AgentToolCall {
  id          String         @id @default(cuid())
  threadId    String
  thread      AgentThread    @relation(fields: [threadId], references: [id], onDelete: Cascade)
  name        String
  arguments   Json           @db.Json
  result      Json?          @db.Json
  status      ToolCallStatus @default(REQUESTED)
  latencyMs   Int?
  createdAt   DateTime       @default(now())
  completedAt DateTime?
  messages    AgentMessage[]

  @@index([threadId])
  @@map("agent_tool_call")
}

model UsageSample {
  id        String          @id @default(cuid())
  userId    String?
  user      User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  projectId String?
  project   Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)
  source    UsageSource     @default(BATCH)
  metric    UsageMetricType
  amount    Int
  metadata  Json?           @db.Json
  createdAt DateTime        @default(now())

  @@index([userId, metric])
  @@index([projectId])
  @@map("usage_sample")
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  projectId    String?
  project      Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  action       String
  resourceType String
  resourceId   String?
  metadata     Json?    @db.Json
  ipAddress    String?
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([projectId])
  @@map("audit_log")
}
