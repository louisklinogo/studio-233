model User {
  id                     String               @id
  name                   String
  email                  String               @unique
  emailVerified          Boolean              @default(false)
  image                  String?
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  hasCompletedOnboarding Boolean              @default(false)
  accounts               Account[]
  threads                AgentThread[]
  apiKeys                ApiKey[]
  auditLogs              AuditLog[]
  batchJobs              BatchJob[]
  canvasSnapshots        CanvasSnapshot[]
  creditEntries          CreditLedger[]
  generationRuns         GenerationRun[]
  projects               Project[]
  sessions               Session[]
  subscriptions          Subscription[]
  usageSamples           UsageSample[]
  settings               UserSetting?
  workflowDefinitions    WorkflowDefinition[]
  workflowRuns           WorkflowRun[]
  workspaces             Workspace[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model UserSetting {
  id              String   @id @default(cuid())
  userId          String   @unique
  timezone        String?  @default("UTC")
  locale          String?  @default("en")
  theme           String?  @default("system")
  notificationOpt Json?    @db.Json
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  defaultMode     String?  @default("canvas")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_setting")
}

model ApiKey {
  id         String       @id @default(cuid())
  userId     String
  name       String
  tokenHash  String       @unique
  status     ApiKeyStatus @default(ACTIVE)
  scopes     String[]     @default([])
  lastUsedAt DateTime?
  expiresAt  DateTime?
  revokedAt  DateTime?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@map("api_key")
}

model Subscription {
  id               String             @id @default(cuid())
  userId           String
  provider         String             @default("polar")
  externalId       String
  productId        String
  planSlug         String?
  status           SubscriptionStatus @default(TRIALING)
  currentPeriodEnd DateTime?
  cancelAt         DateTime?
  canceledAt       DateTime?
  meta             Json?              @db.Json
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, externalId])
  @@index([userId, status])
  @@map("subscription")
}

model CreditLedger {
  id           String          @id @default(cuid())
  userId       String
  entryType    CreditEntryType
  amount       Int
  balanceAfter Int
  reference    String?
  description  String?
  metadata     Json?           @db.Json
  createdAt    DateTime        @default(now())
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("credit_ledger")
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  INCOMPLETE
}

enum ApiKeyStatus {
  ACTIVE
  REVOKED
}

enum CreditEntryType {
  GRANT
  CONSUME
  ADJUSTMENT
  REFUND
}
